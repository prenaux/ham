#!/bin/bash
. "$HAM_HOME/bin/ham-bash-lib.sh"
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ -z "$PM2_ENV_NAME" ]; then
    echo "I/Sourcing _ham_project"

    export HAM_NO_VER_CHECK=1
    WAS_ARGS=( "$@" ) # push arguments
    set -- ""
    . hat . > /dev/null
    set -- "${WAS_ARGS[@]}" # restore arguments
    if [ -z "$PM2_ENV_NAME" ]; then
        echo "E/PM2_ENV_NAME not defined, you should define it in your _ham_project."
        exit 1
    fi

    if [ -z `where_inpath pm2` ]; then
        echo "E/pm2 command not found, you should add nodejs as a toolset in your _ham_project."
        exit 1
    fi

    export PM2_HOME=$TEMPDIR/pm2-${PM2_ENV_NAME}
    echo "I/PM2_ENV_NAME: $PM2_ENV_NAME"
fi

export PM2_HOME=$TEMPDIR/pm2-${PM2_ENV_NAME}
echo "I/PM2_HOME: $PM2_HOME"

usage() {
    echo "I/PM2_VERSION: `pm2 -v`"
    pm2 -h
    echo ""
    echo "  ham-pm2 commands:"
    echo ""
    echo "    source                           To be sourced at the top of a script to warm up the pm2"
    echo "                                     environment to run it multiple times."
    echo "    start-once APP_NAME START_CMD    Start a pm2 process if it isnt already started."
    echo ""
    exit 1
}

if [ -z "$1" ]; then
    usage
elif [ "$1" == source ]; then
    echo -n ""
elif [ "$1" == start-once ]; then
    shift
    APP_NAME="$1"
    if [ -z "$APP_NAME" ]; then
        echo "E/start-once: APP_NAME not specified."
        exit 1
    fi
    shift
    if [ -z "$1" ]; then
        echo "E/start-once: START_CMD not specified."
        exit 1
    fi

    if [[ $((pm2 info "$APP_NAME" || echo 'status|stopped') | grep status) =~ 'online' ]]; then
        echo "I/'$APP_NAME' already started and online."
    else
        echo "I/'$APP_NAME' not online, starting cmd '$@'"
        pm2 start --name "$APP_NAME" "$@"
    fi
else
    set -e
    pm2 "$@"
fi
